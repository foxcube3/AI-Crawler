<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Job Detail</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: 0.5rem; }
    .muted { color: #666; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
    pre { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    label { display:block; margin:8px 0 4px; }
    input[type="text"], textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { padding:8px 12px; border:none; border-radius:6px; background:#0b5ed7; color:#fff; cursor:pointer; }
    button:hover { background:#0949a6; }
  </style>
</head>
<body>
  <h1>Job Detail</h1>
  <p class="muted">Job ID: {{ job_id }}</p>

  <div class="card">
    <strong>Metadata</strong>
    <pre>{{ meta | tojson(indent=2) }}</pre>
  </div>

  <div class="card">
    <strong>Per-domain stats</strong>
    <canvas id="domainChart" width="800" height="300"></canvas>
  </div>

  <div class="card">
    <strong>Report</strong>
    {% if report_href %}
      <a href="{{ report_href }}" target="_blank">Open report</a>
    {% else %}
      <div class="muted">No report available yet.</div>
    {% endif %}
  </div>

  <div class="card">
    <strong>Resume / relaunch with modified parameters</strong>
    <div class="muted">Edit the JSON below and click "Launch" to start a new job with these parameters.</div>
    <label>Parameters (JSON)</label>
    <textarea id="params" rows="10">{{ (meta.params if meta and meta.params else {}) | tojson(indent=2) }}</textarea>
    <button id="launchBtn">Launch</button>
    <div id="launchResp" class="muted" style="margin-top:8px;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = {{ stats_labels | tojson }};
    const totals = {{ stats_totals | tojson }};
    const avgms = {{ stats_avgms | tojson }};
    const errpct = {{ stats_errpct | tojson }};

    const ctx = document.getElementById("domainChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          { label: "Total", data: totals, backgroundColor: "#0b5ed7", yAxisID: "y" },
          { label: "Avg Latency (ms)", data: avgms, type: "line", borderColor: "#ffa726", backgroundColor: "#ffa726", yAxisID: "y1" },
          { label: "Error Rate (%)", data: errpct, type: "line", borderColor: "#ef5350", backgroundColor: "#ef5350", yAxisID: "y1" },
        ],
      },
      options: {
        responsive: false,
        animation: false,
        scales: {
          x: { display: true },
          y: { beginAtZero: true, position: "left", title: { display: true, text: "Total" } },
          y1: { beginAtZero: true, position: "right", title: { display: true, text: "Latency / Error %" } },
        },
      },
    });

    async function postJSON(url, payload) {
      const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      try { return await res.json(); } catch (e) { return { status: res.status, text: await res.text() }; }
    }

    document.getElementById("launchBtn").addEventListener("click", async () => {
      const txt = document.getElementById("params").value;
      let payload = {};
      try { payload = JSON.parse(txt); } catch (e) { alert("Invalid JSON: " + e); return; }
      const resp = await postJSON("/jobs", payload);
      document.getElementById("launchResp").textContent = "Launched job: " + JSON.stringify(resp);
    });
  </script>
</body>
</html>