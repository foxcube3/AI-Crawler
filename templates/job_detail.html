<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Job Detail</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: 0.5rem; }
    .muted { color: #666; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
    pre { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Job Detail</h1>
  <p class="muted">Job ID: {{ job_id }}</p>

  <div class="card">
    <strong>Metadata</strong>
    <pre id="meta"></pre>
  </div>

  <div class="card">
    <strong>Per-domain stats</strong>
    <canvas id="domainChart" width="800" height="300"></canvas>
  </div>

  <div class="card">
    <strong>Report</strong>
    <div id="reports"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function getJSON(url) {
      const res = await fetch(url);
      return await res.json();
    }

    async function load() {
      const jobId = "{{ job_id }}";
      const detail = await getJSON("/jobs/" + jobId);
      document.getElementById("meta").textContent = JSON.stringify(detail.meta || {}, null, 2);

      const statsResp = await getJSON("/analytics/domain-stats?job_id=" + encodeURIComponent(jobId));
      const stats = statsResp.stats || {};
      const labels = Object.keys(stats);
      const totals = labels.map(d => stats[d].total || 0);
      const avgms = labels.map(d => Math.round(stats[d].avg_ms || 0));
      const errpct = labels.map(d => {
        const s = stats[d];
        const errs = (s.fetch_error || 0) + (s.extraction_failed || 0) + (s.error || 0);
        const total = s.total || 1;
        return Math.round((errs / total) * 100);
      });

      const ctx = document.getElementById("domainChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            { label: "Total", data: totals, backgroundColor: "#0b5ed7", yAxisID: "y" },
            { label: "Avg Latency (ms)", data: avgms, type: "line", borderColor: "#ffa726", backgroundColor: "#ffa726", yAxisID: "y1" },
            { label: "Error Rate (%)", data: errpct, type: "line", borderColor: "#ef5350", backgroundColor: "#ef5350", yAxisID: "y1" },
          ],
        },
        options: {
          responsive: false,
          animation: false,
          scales: {
            x: { display: true },
            y: { beginAtZero: true, position: "left", title: { display: true, text: "Total" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Latency / Error %" } },
          },
        },
      });

      const reportsDiv = document.getElementById("reports");
      const pages = (detail.meta && detail.meta.report_pages) || [];
      if (pages.length) {
        const outdir = (detail.meta && detail.meta.output_dir) || "data";
        const a = document.createElement("a");
        a.href = "/reports?output_dir=" + encodeURIComponent(outdir) + "&file=" + encodeURIComponent(pages[0].split('/').pop());
        a.target = "_blank";
        a.textContent = pages[0].split('/').pop();
        reportsDiv.appendChild(a);
      } else {
        reportsDiv.textContent = "No report available yet.";
      }
    }

    load();
  </script>
</body>
</html>